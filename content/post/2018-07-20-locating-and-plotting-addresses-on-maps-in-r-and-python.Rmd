---
title: Locating and Plotting Addresses on Maps in R and Python
author: ~
date: '2018-07-20'
slug: locating-and-plotting-addresses-on-maps-in-r-and-python
categories: ['tutorials']
tags: []
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=F)
setwd("~/github/blog/content/post")
```

The goal of this tutorial is to do the following:

1. Collect addresses (via Google Forms)
2. Download to R (via Google Sheets)
3. Geocode them (via `geocode`)
4. Plot them (using `leaflet`)
5. Get walking distance between them (via Google Maps api)
6. Cluster them (`kmeans?`)


I use the [googlesheets]() API to connect to the google sheet of choice.
[Tutorial](https://datascienceplus.com/how-to-use-googlesheets-to-connect-r-to-google-sheets/) for first-timers. Also, this [vignette](https://rawgit.com/jennybc/googlesheets/master/vignettes/basic-usage.html#get-a-google-sheet-to-practice-with)
.

```{r, message=FALSE, warning=FALSE}
devtools::install_github("dkahle/ggmap") # for the register_google function
install.load::install_load('googlesheets', 'dplyr', 'leaflet', 'magrittr', 'ggmap')
```
```{r sheets1, eval=FALSE}
# Run this to authorize your google account
gs_auth(new_user=TRUE)
```

Create a Form:
1. Visit drive.google.com
2. Create a Form 
3. Collect responses (hit up some random [fake address generator] for inspiration)
4. Save the responses to a new sheet `fake_addresses`

Steps in pretty picture form:
![](resources/20180720/create_form1.png)
![](resources/20180720/go_to_responses.png)
![](resources/20180720/create_sheet.png)

```{r sheets, eval=FALSE}
wb_name <- gs_title('fake_addresses')
# Or, if published to web, enter the key after /d/ in the url:
# wb_name <- gs_key('198ng981...')
wb <- gs_read(wb_name)
# Save it to csv (you could skip this)
wb %>% write.csv('resources/20180720/addresses.csv')
```

Read it in and inspect
```{r read}
wb <- read.csv('resources/20180720/addresses.csv')
wb %<>% select(-X, -Timestamp)
colnames(wb) <- c('address', 'favorite_color', 'favorite_food')
wb$address %<>% as.character() # geocode requires a character, not level
wb %>% knitr::kable()
```

# Geocode the addresses
To use the `geocode` funciton, you may need to create a google maps API if you over-do your quota.
```{r}
# load the googlemaps api
api_key = trimws(readChar('resources/google_maps_api', 1000))
register_google(key = api_key)
substr(api_key, 1, 3)
```

Use geocode each address.
```{r, eval=FALSE}
df <- wb
df$lon <- 0
df$lat <- 0
df$geoAddress <- ""

for(i in 1:nrow(df))
{
  if(!is.na(df$address[i])){
    result <- geocode(df$address[i], output = "latlona", source = "google")
    df$lon[i] <- as.numeric(result[1])
    df$lat[i] <- as.numeric(result[2])
    df$geoAddress[i] <- as.character(result[3])
  }
}
df %>% knitr::kable()
```
```{r, eval=FALSE, echo=FALSE}
# df %>% write.csv('resources/20180720/addresses2.csv')
```
```{r, echo=FALSE}
df <- read.csv('resources/20180720/addresses2.csv')
```

## Plot in leaflet
### Basic plot
```{r}
df %>%
   leaflet() %>% 
    addTiles() %>%
    addMarkers(~lon, ~lat)
```


## Bugs I hit:
I hit a lot of bugs when building this tutorial.

First bug: Trying to do `blogdown::serve_site()`. I got the following `googlesheets` warning:
> Error: oauth_listener() needs an interactive environment.

Solution: don't do `gs_auth()` and `gs_title()`. Those only work in personal browsing. For public mode, use `gs_key()`.


Second bug: (Right after the first). I got this bug:https://github.com/rstudio/blogdown/issues/130

Proposed solution:
```
update.packages(ask = FALSE, checkBuilt = TRUE)
```

Then I see at the bottom: https://github.com/tidyverse/lubridate/issues/615, that this is actually a Mac issue with OS Sierra, so I [download R 3.5.1](https://cran.r-project.org/bin/macosx/). Then I discover I have to re-install all of my R packages.

Third bug trying to run via Rmarkdown
```
Error in stop_for_content_type(req, expected = "application/atom+xml; charset=UTF-8") :
```
Then I give up when I find this: https://github.com/jennybc/googlesheets/issues/272. You probably need to publish the sheet to the web to use it in a script. So I'm going to just use a csv. And you thougt Data Science wasn't 90% package management?...sigh.

And then I thought, I don't want to use google sheets every time I run this RMarkdown anyway, in case things break down the road. So I'm just going to download the file to csv...