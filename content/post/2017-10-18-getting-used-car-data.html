---
title: Webscraping Thousands of Used Cars
author: ~
date: '2017-10-18'
slug: getting-used-car-data
categories: ['tutorials']
tags: ['r', 'webscraping']
---



<p>In another post, I describe how I use this data that I’ve scraped, but I wanted to provide a more in-depth tutorial for those interested in how I got the data. Note, this data belongs to Truecar, so all uses herein are for personal and academic reasons only.</p>
<div id="get-the-data" class="section level1">
<h1>Get the data</h1>
<p>In order to do any good analaysis, you first need data. I prefer to have more data than less, where possible. In this case, I don’t have any data, so I use webscraping to get the data. There are much better tutorials on how to scrape data, so I’ll be light. I use R’s <code>rvest</code> package here, which does a decent job.<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a> Let’s look at Truecar’s Used Car postings<a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a>. First I use <code>google</code> to find the search query on Truecar that I like.</p>
<pre class="r"><code># Load packages
library(rvest)
library(dplyr)
library(magrittr)</code></pre>
<pre class="r"><code># Find the URL of the data you want to scrape
url &lt;- &#39;https://www.truecar.com/used-cars-for-sale/listings/ford/edge/location-90210/year-2015-max/?trimSlug=sel-awd&#39;
read_html(url)</code></pre>
<pre><code>## {xml_document}
## &lt;html lang=&quot;en-US&quot; data-qa=&quot;Index&quot;&gt;
## [1] &lt;head&gt;\n&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset= ...
## [2] &lt;body&gt;&lt;div&gt;\n&lt;div&gt;&lt;div id=&quot;main&quot;&gt;&lt;div&gt;&lt;div data-qa=&quot;TransitionHooks&quot; ...</code></pre>
<p>You’ll see there’s a head and a body. Our data’s in the body, so let’s use <code>html_nodes()</code> and <code>html_text()</code> to parse out the data we want. I used <a href="https://cran.r-project.org/web/packages/rvest/vignettes/selectorgadget.html">Selectorgadget</a> to know what HTML classes to search for.</p>
<pre class="r"><code>read_html(url) %&gt;% html_nodes(&#39;.col-xs-6.col-sm-8.no-left-padding&#39;) %&gt;% html_text()</code></pre>
<pre><code>##  [1] &quot;2015 Ford EdgeSEMileage: 45,702 milesLocation: Santa Ana, CAExterior: Ingot Silver MetallicInterior: BlackVIN: 2FMTK3G84FBB96919$14,899View Details&quot;                                       
##  [2] &quot;2015 Ford EdgeSEMileage: 31,750 milesLocation: Los Angeles, CAExterior: SilverInterior: BlackVIN: 2FMTK3G96FBB52901 Rating: Great Price$17,980$6,458 below marketView Details&quot;             
##  [3] &quot;2015 Ford EdgeSEMileage: 62,844 milesLocation: Pacoima, CAExterior: BlackVIN: 2FMTK4G87FBB97410$15,482View Details&quot;                                                                        
##  [4] &quot;2015 Ford EdgeSEMileage: 36,399 milesLocation: Huntington Beach, CAExterior: Tuxedo BlackInterior: EbonyVIN: 2FMTK3G97FBB92565$17,890View Details&quot;                                         
##  [5] &quot;2015 Ford EdgeSEMileage: 35,874 milesLocation: Huntington Beach, CAExterior: Tuxedo Black MetallicInterior: EbonyVIN: 2FMTK3G98FBC34774$18,990View Details&quot;                                
##  [6] &quot;2015 Ford EdgeSELMileage: 21,829 milesLocation: Los Angeles, CAExterior: GrayInterior: BlackVIN: 2FMTK3J95FBB01835 Rating: Great Price$20,480$7,063 below marketView Details&quot;              
##  [7] &quot;2015 Ford EdgeSEMileage: 62,747 milesLocation: Montclair, CAExterior: GrayInterior: TanVIN: 2FMTK3G98FBB43553Discount Available  Rating: Great Price$15,400$8,373 below marketView Details&quot;
##  [8] &quot;2015 Ford EdgeSEMileage: 7,526 milesLocation: Glendale, CAExterior: WhiteInterior: DuneVIN: 2FMTK3G95FBC20895$22,500View Details&quot;                                                          
##  [9] &quot;2015 Ford EdgeSEMileage: 22,098 milesLocation: Downey, CAExterior: WhiteInterior: BlackVIN: 2FMTK4G88FBC08043$20,400View Details&quot;                                                          
## [10] &quot;2015 Ford EdgeSEMileage: 30,332 milesLocation: Downey, CAExterior: WhiteInterior: BlackVIN: 2FMTK4G92FBB40573$19,900View Details&quot;                                                          
## [11] &quot;2015 Ford EdgeSELMileage: 33,841 milesLocation: Downey, CAExterior: BlackInterior: BlackVIN: 2FMTK3J86FBB20045 Rating: Great Price$21,500$4,454 below marketView Details&quot;                  
## [12] &quot;2015 Ford EdgeSELMileage: 5,470 milesLocation: Glendora, CAExterior: Guard MetallicInterior: EbonyVIN: 2FMTK3J98FBC40065$23,965View Details&quot;                                               
## [13] &quot;2015 Ford EdgeTitaniumMileage: 30,703 milesLocation: Montebello, CAExterior: Tuxedo Black MetallicInterior: BlackVIN: 2FMPK3K8XFBB06293$22,499View Details&quot;                                
## [14] &quot;2015 Ford EdgeSELMileage: 41,010 milesLocation: GARDEN GROVE, CAExterior: GrayInterior: EbonyVIN: 2FMTK3J94FBB47723$22,495View Details&quot;                                                    
## [15] &quot;2015 Ford EdgeSELMileage: 77,865 milesLocation: Rancho Santa Margarita, CAExterior: Tuxedo Black MetallicInterior: DuneVIN: 2FMTK3J94FBB47740$18,700View Details&quot;                          
## [16] &quot;2015 Ford EdgeSELMileage: 18,208 milesLocation: Carson, CAExterior: Ingot Silver MetallicInterior: EbonyVIN: 2FMTK4J82FBC05227Discount Available $24,997View Details&quot;                      
## [17] &quot;2015 Ford EdgeSELMileage: 30,942 milesLocation: Huntington Beach, CAExterior: Ingot SilverInterior: EbonyVIN: 2FMTK3J98FBB45599$23,490View Details&quot;                                        
## [18] &quot;2015 Ford EdgeSELMileage: 38,035 milesLocation: Downey, CAExterior: WhiteInterior: BeigeVIN: 2FMTK4J93FBB59643$22,100View Details&quot;                                                         
## [19] &quot;2015 Ford EdgeSELMileage: 38,633 milesLocation: Downey, CAExterior: BlackInterior: BlackVIN: 2FMTK4J9XFBC10183$22,200View Details&quot;                                                         
## [20] &quot;2015 Ford EdgeSELMileage: 27,169 milesLocation: Alhambra, CAExterior: BlackInterior: EbonyVIN: 2FMTK3J94FBB45521$24,991View Details&quot;                                                       
## [21] &quot;2015 Ford EdgeSELMileage: 24,922 milesLocation: Long Beach, CAExterior: BlackInterior: EbonyVIN: 2FMTK3J8XFBB55896Discount Available $24,378View Details&quot;                                  
## [22] &quot;2015 Ford EdgeTitaniumMileage: 19,284 milesLocation: Huntington Beach, CAExterior: Tuxedo Black MetallicInterior: EbonyVIN: 2FMPK3K87FBB67701$25,590View Details&quot;                          
## [23] &quot;2015 Ford EdgeTitaniumMileage: 36,482 milesLocation: Downey, CAExterior: SilverInterior: BlackVIN: 2FMTK3K9XFBB06656 Rating: Great Price$23,400$6,371 below marketView Details&quot;            
## [24] &quot;2015 Ford EdgeSELMileage: 29,704 milesLocation: Huntington Beach, CAExterior: Tuxedo BlackInterior: EbonyVIN: 2FMTK3J99FBB47748$24,890View Details&quot;                                        
## [25] &quot;2015 Ford EdgeSELMileage: 19,405 milesLocation: Long Beach, CAExterior: BlackInterior: EbonyVIN: 2FMTK3J80FBB34135Discount Available $25,133View Details&quot;</code></pre>
<p>So that’s how you get the data on a single page. If you look closer at the URL, you see a lot of helpful things. First, there’s the make, then the model, then the location-zip, then the year-range, and ultimately the trim. This is a very pretty and clean URL. If you click on a few additional pages, you’ll see the URL opens up with <code>?page=2</code>.</p>
<pre><code>https://www.truecar.com/used-cars-for-sale/listings/ford/edge/location-90210/?page=2</code></pre>
<p>This is our ‘in’ to scraping multiple pages. I won’t bore you with the details of how to get <em>that</em> data into a neat matrix for us to analyze, but suffice it to say that I’m able to do it. Just build a function to construct a URL, and build a loop to go through the different pages, then use lots of <code>str_extract</code> from the <code>stringr</code> package and <code>gsub</code> to clean up the data.</p>
<pre class="r"><code>library(stringr)

make = &#39;ford&#39;
model = &#39;edge&#39;
zip = &#39;90210&#39;
year = 2012
npages = 5

url &lt;- paste(&#39;https://www.truecar.com/used-cars-for-sale/listings/&#39;, 
             make, &#39;/&#39;, 
             model ,
             &#39;/location-&#39;, zip,
             &#39;/year-&#39;,year,&#39;-max/?page=&#39;, sep = &quot;&quot;)

urls &lt;- paste(url, 1:npages, sep = &quot;&quot;)

scrape &lt;- function(pageno){
  try(
    read_html(urls[pageno]) %&gt;% html_nodes(&#39;.col-xs-6.col-sm-8.no-left-padding&#39;) %&gt;% html_text()
  )
}

long_list = scrape(1)
for(i in 2:npages){
  print(i)
  new_list = try(scrape(i))
  
  error = (&quot;try-error&quot; %in% class(new_list))
  
  if( error == FALSE ){
    long_list = c(long_list, new_list) 
  } else {
    break
  }
}</code></pre>
<pre><code>## [1] 2
## [1] 3
## [1] 4
## [1] 5</code></pre>
<pre class="r"><code>stats &lt;- long_list
df &lt;- as.data.frame(stats)
df$stats %&lt;&gt;% as.character()
df$price &lt;- str_extract(df$stats, &#39;\\$[0-9]*,[0-9]*&#39;) %&gt;% 
  gsub(&#39;Price: |\\$|,&#39;, &#39;&#39;, .) %&gt;%
  as.numeric()
df$year &lt;- str_extract(df$stats, &#39;^[0-9]* &#39;) %&gt;% 
  as.numeric()
df$mileage &lt;- str_extract(df$stats, &#39;Mileage: [0-9]*,[0-9]*&#39;) %&gt;% 
  gsub(&#39;Mileage: |,&#39;, &#39;&#39;, .) %&gt;%
  as.numeric()

# a = df$stats[1]
df$trim &lt;- str_extract(df$stats, &#39;.*Mileage:&#39;) %&gt;% 
  gsub(&#39;FWD|AWD|4x[24]|[24]WD|V6|4-cyl|^[0-9][0-9][0-9][0-9]|4dr|Automatic|Manual|Mileage:&#39;, &#39;&#39;, ., ignore.case = T) %&gt;% 
  gsub(make, &#39;&#39;, ., ignore.case = T) %&gt;% 
  gsub(model, &#39;&#39;, ., ignore.case = T) %&gt;% 
  trimws() 


df$awd &lt;- grepl(&#39;AWD|4WD|4x4&#39;, df$stats, ignore.case = T) %&gt;% as.numeric()
df$manual &lt;- grepl(&#39;manual&#39;, df$stats) %&gt;% as.numeric()
df$v6 &lt;- grepl(&#39;V6&#39;, df$stats) %&gt;% as.numeric()
df$location &lt;- str_extract(df$stats, &#39;Location: .*Exterior:&#39;) %&gt;% 
  gsub(&#39;Location: |Exterior:&#39;, &#39;&#39;, .) %&gt;% 
  trimws() 
df$ext &lt;- str_extract(df$stats, &#39;Exterior: .*Interior:&#39;) %&gt;% 
  gsub(&#39;Interior:|Exterior:&#39;, &#39;&#39;, .) %&gt;% 
  trimws() 
df$int &lt;- str_extract(df$stats, &#39;Interior: .*VIN:&#39;) %&gt;% 
  gsub(&#39;Interior: |VIN:&#39;, &#39;&#39;, .) %&gt;% 
  trimws() 
df$vin &lt;- str_extract(df$stats, &#39;VIN: .*\\$&#39;) %&gt;% 
  gsub(&#39;VIN: |\\$&#39;, &#39;&#39;, .) %&gt;% 
  substr(., 1, 17)
df$deal &lt;- str_extract(df$stats, &#39;\\$[0-9]*,[0-9]* below&#39;) %&gt;% 
  gsub(&#39;below|\\$|,&#39;, &#39;&#39;, .) %&gt;% trimws() %&gt;%
  as.numeric()</code></pre>
<p>And here’s what the results look like. You’ve got the original scraped data in the <code>stats</code> column and then everything else that you can parse out. Just like that, you’ve got</p>
<pre class="r"><code># df was the dataframe object we needed
df %&gt;% select(-stats) %&gt;% head(10) %&gt;% formattable::formattable()</code></pre>
<table class="table table-condensed">
<thead>
<tr>
<th style="text-align:right;">
price
</th>
<th style="text-align:right;">
year
</th>
<th style="text-align:right;">
mileage
</th>
<th style="text-align:right;">
trim
</th>
<th style="text-align:right;">
awd
</th>
<th style="text-align:right;">
manual
</th>
<th style="text-align:right;">
v6
</th>
<th style="text-align:right;">
location
</th>
<th style="text-align:right;">
ext
</th>
<th style="text-align:right;">
int
</th>
<th style="text-align:right;">
vin
</th>
<th style="text-align:right;">
deal
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
12967
</td>
<td style="text-align:right;">
2012
</td>
<td style="text-align:right;">
87179
</td>
<td style="text-align:right;">
SEL
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
Long Beach, CA
</td>
<td style="text-align:right;">
Ingot Silver Metallic
</td>
<td style="text-align:right;">
Charcoal Black
</td>
<td style="text-align:right;">
2FMDK3JCXCBA82243
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:right;">
13333
</td>
<td style="text-align:right;">
2012
</td>
<td style="text-align:right;">
83415
</td>
<td style="text-align:right;">
Limited
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
Thousand Oaks, CA
</td>
<td style="text-align:right;">
White
</td>
<td style="text-align:right;">
Tan
</td>
<td style="text-align:right;">
2FMDK3KC6CBA95361
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:right;">
18000
</td>
<td style="text-align:right;">
2012
</td>
<td style="text-align:right;">
41470
</td>
<td style="text-align:right;">
SEL
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
Woodland Hills, CA
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
2FMDK3J94CBA49744
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:right;">
14992
</td>
<td style="text-align:right;">
2012
</td>
<td style="text-align:right;">
77883
</td>
<td style="text-align:right;">
Limited
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
Mission Hills, CA
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
2FMDK3KC2CBA41460
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:right;">
13980
</td>
<td style="text-align:right;">
2012
</td>
<td style="text-align:right;">
83603
</td>
<td style="text-align:right;">
Limited
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
Irvine, CA
</td>
<td style="text-align:right;">
Ingot Silver Metallic
</td>
<td style="text-align:right;">
Charcoal Black
</td>
<td style="text-align:right;">
2FMDK3K96CBA46150
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:right;">
17980
</td>
<td style="text-align:right;">
2012
</td>
<td style="text-align:right;">
58297
</td>
<td style="text-align:right;">
Sport
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
Buena Park, CA
</td>
<td style="text-align:right;">
Tuxedo Black Metallic
</td>
<td style="text-align:right;">
Charcoal Black
</td>
<td style="text-align:right;">
2FMDK3AK7CBA93272
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:right;">
14777
</td>
<td style="text-align:right;">
2012
</td>
<td style="text-align:right;">
74332
</td>
<td style="text-align:right;">
Limited
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
Ontario, CA
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
2FMDK3K91CBA92484
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:right;">
17399
</td>
<td style="text-align:right;">
2012
</td>
<td style="text-align:right;">
68191
</td>
<td style="text-align:right;">
Sport
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
Santa Ana, CA
</td>
<td style="text-align:right;">
Black
</td>
<td style="text-align:right;">
Charcoal Black
</td>
<td style="text-align:right;">
2FMDK3AKXCBA12748
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:right;">
12967
</td>
<td style="text-align:right;">
2012
</td>
<td style="text-align:right;">
87179
</td>
<td style="text-align:right;">
SEL
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
Long Beach, CA
</td>
<td style="text-align:right;">
Ingot Silver Metallic
</td>
<td style="text-align:right;">
Charcoal Black
</td>
<td style="text-align:right;">
2FMDK3JCXCBA82243
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:right;">
13333
</td>
<td style="text-align:right;">
2012
</td>
<td style="text-align:right;">
83415
</td>
<td style="text-align:right;">
Limited
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
Thousand Oaks, CA
</td>
<td style="text-align:right;">
White
</td>
<td style="text-align:right;">
Tan
</td>
<td style="text-align:right;">
2FMDK3KC6CBA95361
</td>
<td style="text-align:right;">
NA
</td>
</tr>
</tbody>
</table>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>Python’s <code>beautifulSoup</code> package could probably do a better job.<a href="#fnref1">↩</a></p></li>
<li id="fn2"><p>I tried scraping CarGurus, but wasn’t able to paginate. I tried scraping CarMax, but had difficulty. Edmunds was also easy, but Truecar was easiset.<a href="#fnref2">↩</a></p></li>
</ol>
</div>
