---
title: Webscraping Thousands of Used Cars
author: ~
date: '2017-10-18'
slug: getting-used-car-data
categories: ['tutorials']
tags: ['r', 'webscraping']
---



<p>In another post, I describe how I use this data that I’ve scraped, but I wanted to provide a more in-depth tutorial for those interested in how I got the data. Note, this data belongs to Truecar, so all uses herein are for personal and academic reasons only.</p>
<div id="get-the-data" class="section level1">
<h1>Get the data</h1>
<p>In order to do any good analaysis, you first need data. I prefer to have more data than less, where possible. In this case, I don’t have any data, so I use webscraping to get the data. There are much better tutorials on how to scrape data, so I’ll be light. I use R’s <code>rvest</code> package here, which does a decent job.<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a> Let’s look at Truecar’s Used Car postings<a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a>. First I use <code>google</code> to find the search query on Truecar that I like.</p>
<pre class="r"><code># Load packages
library(rvest)
library(dplyr)
library(magrittr)</code></pre>
<pre class="r"><code># Find the URL of the data you want to scrape
url &lt;- &#39;https://www.truecar.com/used-cars-for-sale/listings/ford/edge/location-90210/year-2015-max/?trimSlug=sel-awd&#39;
read_html(url)</code></pre>
<pre><code>## {xml_document}
## &lt;html lang=&quot;en-US&quot; data-qa=&quot;Index&quot;&gt;
## [1] &lt;head&gt;\n&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset= ...
## [2] &lt;body&gt;&lt;div&gt;\n&lt;div&gt;&lt;div id=&quot;main&quot;&gt;&lt;div&gt;&lt;div data-qa=&quot;TransitionHooks&quot; ...</code></pre>
<p>You’ll see there’s a head and a body. Our data’s in the body, so let’s use <code>html_nodes()</code> and <code>html_text()</code> to parse out the data we want. I used <a href="https://cran.r-project.org/web/packages/rvest/vignettes/selectorgadget.html">Selectorgadget</a> to know what HTML classes to search for.</p>
<pre class="r"><code>read_html(url) %&gt;% html_nodes(&#39;.col-xs-6.col-sm-8.no-left-padding&#39;) %&gt;% html_text()</code></pre>
<pre><code>##  [1] &quot;2015 Ford EdgeSE FWDMileage: 32,880 milesLocation: Alhambra, CAExterior: GrayInterior: EbonyVIN: 2FMTK3G89FBB59011$17,711View Details&quot;                                                         
##  [2] &quot;2015 Ford EdgeSE FWDMileage: 70,069 milesLocation: Whittier, CAExterior: GreyInterior: BlackVIN: 2FMTK3G84FBB39684Discount Available $13,995View Details&quot;                                      
##  [3] &quot;2015 Ford EdgeSE FWDMileage: 45,117 milesLocation: Downey, CAExterior: Dk. GrayInterior: BeigeVIN: 2FMTK3G86FBB43431$16,500View Details&quot;                                                       
##  [4] &quot;2015 Ford EdgeSE FWDMileage: 79,835 milesLocation: Santa Ana, CAExterior: Magnetic MetallicInterior: DuneVIN: 2FMTK3G88FBB43320$13,488View Details&quot;                                            
##  [5] &quot;2015 Ford EdgeSE FWDMileage: 56,510 milesLocation: Downey, CAExterior: GrayInterior: BeigeVIN: 2FMTK3G85FBB43338$16,000View Details&quot;                                                           
##  [6] &quot;2015 Ford EdgeSE FWDMileage: 18,444 milesLocation: Downey, CAExterior: BlueInterior: BlackVIN: 2FMTK3G9XFBC34534$19,597View Details&quot;                                                           
##  [7] &quot;2015 Ford EdgeSE FWDMileage: 14,803 milesLocation: Downey, CAExterior: WhiteInterior: BeigeVIN: 2FMTK3G81FBC01977$19,600View Details&quot;                                                          
##  [8] &quot;2015 Ford EdgeSE FWDMileage: 55,315 milesLocation: Alhambra, CAExterior: WhiteInterior: EbonyVIN: 2FMTK3G91FBB67564$17,711View Details&quot;                                                        
##  [9] &quot;2015 Ford EdgeSE FWDMileage: 77,145 milesLocation: Santa Ana, CAExterior: Oxford WhiteInterior: EbonyVIN: 2FMTK3G90FBB43093$13,998View Details&quot;                                                
## [10] &quot;2015 Ford EdgeSEL FWDMileage: 54,453 milesLocation: Placentia, CAExterior: WhiteVIN: 2FMTK3J82FBC23818$15,999View Details&quot;                                                                     
## [11] &quot;2015 Ford EdgeSE FWDMileage: 18,969 milesLocation: Placentia, CAExterior: Tuxedo Black MetallicInterior: EbonyVIN: 2FMTK3G90FBB67457$18,999View Details&quot;                                       
## [12] &quot;2015 Ford EdgeSE FWDMileage: 46,916 milesLocation: Downey, CAExterior: BlackInterior: BlackVIN: 2FMTK3G80FBB52769$17,200View Details&quot;                                                          
## [13] &quot;2015 Ford EdgeSEL FWDMileage: 45,104 milesLocation: Downey, CAExterior: WhiteInterior: GoldVIN: 2FMTK3J92FBB73835$17,999View Details&quot;                                                          
## [14] &quot;2015 Ford EdgeSE FWDMileage: 62,747 milesLocation: Montclair, CAExterior: GrayInterior: TanVIN: 2FMTK3G98FBB43553Discount Available  Rating: Great Price$14,995$8,778 below marketView Details&quot;
## [15] &quot;2015 Ford EdgeSE FWDMileage: 70,818 milesLocation: Downey, CAExterior: BlackInterior: BlackVIN: 2FMTK3G83FBB39661$15,400View Details&quot;                                                          
## [16] &quot;2015 Ford EdgeSE FWDMileage: 35,553 milesLocation: Costa Mesa, CAExterior: Oxford WhiteInterior: BlackVIN: 2FMTK3G88FBB38926$17,790View Details&quot;                                               
## [17] &quot;2015 Ford EdgeSEL FWDMileage: 62,015 milesLocation: Torrance, CAExterior: White Platinum Metallic Tri-CoatInterior: DuneVIN: 2FMTK3J95FBB34110$18,995View Details&quot;                             
## [18] &quot;2015 Ford EdgeSE FWDMileage: 28,875 milesLocation: Costa Mesa, CAExterior: Oxford WhiteInterior: GrayVIN: 2FMTK3G80FBB39150$18,490View Details&quot;                                                
## [19] &quot;2015 Ford EdgeSEL FWDMileage: 83,984 milesLocation: Van Nuys, CAExterior: Guard MetallicInterior: DuneVIN: 2FMTK3J83FBB04109$16,100View Details&quot;                                               
## [20] &quot;2015 Ford EdgeSEL FWDMileage: 29,690 milesLocation: Santa Ana, CAExterior: Ingot Silver MetallicInterior: BlackVIN: 2FMTK3J91FBB74278$19,199View Details&quot;                                      
## [21] &quot;2015 Ford EdgeSEL AWDMileage: 18,208 milesLocation: Carson, CAExterior: Ingot Silver MetallicInterior: EbonyVIN: 2FMTK4J82FBC05227Discount Available $22,195View Details&quot;                      
## [22] &quot;2015 Ford EdgeSEL AWDMileage: 26,495 milesLocation: Carson, CAExterior: BlackVIN: 2FMTK4J88FBB21347Discount Available $21,991View Details&quot;                                                     
## [23] &quot;2015 Ford EdgeSEL FWDMileage: 11,850 milesLocation: Norco, CAExterior: WhiteInterior: BlackVIN: 2FMPK3J80FBB67928$20,499View Details&quot;                                                          
## [24] &quot;2015 Ford EdgeSEL FWDMileage: 29,516 milesLocation: Torrance, CAExterior: BlackInterior: EbonyVIN: 2FMTK3J97FBB92848$23,260View Details&quot;                                                       
## [25] &quot;2015 Ford EdgeSEL FWDMileage: 27,108 milesLocation: Montebello, CAExterior: GrayInterior: BlackVIN: 2FMTK3J86FBB60853$21,499View Details&quot;                                                      
## [26] &quot;2015 Ford EdgeSEL FWDMileage: 17,376 milesLocation: Huntington Beach, CAExterior: White Platinum Metallic Tri-CoatInterior: EbonyVIN: 2FMTK3J91FBC26878$22,790View Details&quot;                    
## [27] &quot;2015 Ford EdgeSEL AWDMileage: 26,321 milesLocation: Torrance, CAExterior: Oxford WhiteInterior: EbonyVIN: 2FMTK4J93FBB60937$23,462View Details&quot;                                                
## [28] &quot;2015 Ford EdgeSE FWDMileage: 27,695 milesLocation: Chino, CAExterior: Ingot Silver MetallicInterior: EbonyVIN: 2FMTK3G92FBB67413$20,775View Details&quot;                                           
## [29] &quot;2015 Ford EdgeSEL FWDMileage: 27,169 milesLocation: Alhambra, CAExterior: BlackInterior: EbonyVIN: 2FMTK3J94FBB45521$22,991View Details&quot;                                                       
## [30] &quot;2015 Ford EdgeSEL FWDMileage: 66,586 milesLocation: North Hollywood, CAExterior: Tuxedo Black MInterior: BlackVIN: 2FMTK3J80FBB06271Discount Available $20,995View Details&quot;</code></pre>
<p>So that’s how you get the data on a single page. If you look closer at the URL, you see a lot of helpful things. First, there’s the make, then the model, then the location-zip, then the year-range, and ultimately the trim. This is a very pretty and clean URL. If you click on a few additional pages, you’ll see the URL opens up with <code>?page=2</code>.</p>
<pre><code>https://www.truecar.com/used-cars-for-sale/listings/ford/edge/location-90210/?page=2</code></pre>
<p>This is our ‘in’ to scraping multiple pages. I won’t bore you with the details of how to get <em>that</em> data into a neat matrix for us to analyze, but suffice it to say that I’m able to do it. Just build a function to construct a URL, and build a loop to go through the different pages, then use lots of <code>str_extract</code> from the <code>stringr</code> package and <code>gsub</code> to clean up the data.</p>
<pre class="r"><code>library(stringr)

make = &#39;ford&#39;
model = &#39;edge&#39;
zip = &#39;90210&#39;
year = 2012
npages = 5

url &lt;- paste(&#39;https://www.truecar.com/used-cars-for-sale/listings/&#39;, 
             make, &#39;/&#39;, 
             model ,
             &#39;/location-&#39;, zip,
             &#39;/year-&#39;,year,&#39;-max/?page=&#39;, sep = &quot;&quot;)

urls &lt;- paste(url, 1:npages, sep = &quot;&quot;)

scrape &lt;- function(pageno){
  try(
    read_html(urls[pageno]) %&gt;% html_nodes(&#39;.col-xs-6.col-sm-8.no-left-padding&#39;) %&gt;% html_text()
  )
}

long_list = scrape(1)
for(i in 2:npages){
  print(i)
  new_list = try(scrape(i))
  
  error = (&quot;try-error&quot; %in% class(new_list))
  
  if( error == FALSE ){
    long_list = c(long_list, new_list) 
  } else {
    break
  }
}</code></pre>
<pre><code>## [1] 2
## [1] 3
## [1] 4
## [1] 5</code></pre>
<pre class="r"><code>stats &lt;- long_list
df &lt;- as.data.frame(stats)
df$stats %&lt;&gt;% as.character()
df$price &lt;- str_extract(df$stats, &#39;\\$[0-9]*,[0-9]*&#39;) %&gt;% 
  gsub(&#39;Price: |\\$|,&#39;, &#39;&#39;, .) %&gt;%
  as.numeric()
df$year &lt;- str_extract(df$stats, &#39;^[0-9]* &#39;) %&gt;% 
  as.numeric()
df$mileage &lt;- str_extract(df$stats, &#39;Mileage: [0-9]*,[0-9]*&#39;) %&gt;% 
  gsub(&#39;Mileage: |,&#39;, &#39;&#39;, .) %&gt;%
  as.numeric()

# a = df$stats[1]
df$trim &lt;- str_extract(df$stats, &#39;.*Mileage:&#39;) %&gt;% 
  gsub(&#39;FWD|AWD|4x[24]|[24]WD|V6|4-cyl|^[0-9][0-9][0-9][0-9]|4dr|Automatic|Manual|Mileage:&#39;, &#39;&#39;, ., ignore.case = T) %&gt;% 
  gsub(make, &#39;&#39;, ., ignore.case = T) %&gt;% 
  gsub(model, &#39;&#39;, ., ignore.case = T) %&gt;% 
  trimws() 


df$awd &lt;- grepl(&#39;AWD|4WD|4x4&#39;, df$stats, ignore.case = T) %&gt;% as.numeric()
df$manual &lt;- grepl(&#39;manual&#39;, df$stats) %&gt;% as.numeric()
df$v6 &lt;- grepl(&#39;V6&#39;, df$stats) %&gt;% as.numeric()
df$location &lt;- str_extract(df$stats, &#39;Location: .*Exterior:&#39;) %&gt;% 
  gsub(&#39;Location: |Exterior:&#39;, &#39;&#39;, .) %&gt;% 
  trimws() 
df$ext &lt;- str_extract(df$stats, &#39;Exterior: .*Interior:&#39;) %&gt;% 
  gsub(&#39;Interior:|Exterior:&#39;, &#39;&#39;, .) %&gt;% 
  trimws() 
df$int &lt;- str_extract(df$stats, &#39;Interior: .*VIN:&#39;) %&gt;% 
  gsub(&#39;Interior: |VIN:&#39;, &#39;&#39;, .) %&gt;% 
  trimws() 
df$vin &lt;- str_extract(df$stats, &#39;VIN: .*\\$&#39;) %&gt;% 
  gsub(&#39;VIN: |\\$&#39;, &#39;&#39;, .) %&gt;% 
  substr(., 1, 17)
df$deal &lt;- str_extract(df$stats, &#39;\\$[0-9]*,[0-9]* below&#39;) %&gt;% 
  gsub(&#39;below|\\$|,&#39;, &#39;&#39;, .) %&gt;% trimws() %&gt;%
  as.numeric()</code></pre>
<p>And here’s what the results look like. You’ve got the original scraped data in the <code>stats</code> column and then everything else that you can parse out. Just like that, you’ve got</p>
<pre class="r"><code># df was the dataframe object we needed
df %&gt;% select(-stats) %&gt;% head(10) %&gt;% formattable::formattable()</code></pre>
<table class="table table-condensed">
<thead>
<tr>
<th style="text-align:right;">
price
</th>
<th style="text-align:right;">
year
</th>
<th style="text-align:right;">
mileage
</th>
<th style="text-align:right;">
trim
</th>
<th style="text-align:right;">
awd
</th>
<th style="text-align:right;">
manual
</th>
<th style="text-align:right;">
v6
</th>
<th style="text-align:right;">
location
</th>
<th style="text-align:right;">
ext
</th>
<th style="text-align:right;">
int
</th>
<th style="text-align:right;">
vin
</th>
<th style="text-align:right;">
deal
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
12599
</td>
<td style="text-align:right;">
2012
</td>
<td style="text-align:right;">
87724
</td>
<td style="text-align:right;">
SEL
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
La Habra, CA
</td>
<td style="text-align:right;">
Silver
</td>
<td style="text-align:right;">
Beige
</td>
<td style="text-align:right;">
2FMDK3J9XCBA82165
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:right;">
13711
</td>
<td style="text-align:right;">
2012
</td>
<td style="text-align:right;">
94112
</td>
<td style="text-align:right;">
Limited
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
Alhambra, CA
</td>
<td style="text-align:right;">
White Platinum
</td>
<td style="text-align:right;">
Charcoal Black
</td>
<td style="text-align:right;">
2FMDK3KC2CBA41538
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:right;">
14987
</td>
<td style="text-align:right;">
2012
</td>
<td style="text-align:right;">
77240
</td>
<td style="text-align:right;">
Limited
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
Lancaster, CA
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
2FMDK3KCXCBA41688
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:right;">
15432
</td>
<td style="text-align:right;">
2012
</td>
<td style="text-align:right;">
61006
</td>
<td style="text-align:right;">
Limited
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
Corona, CA
</td>
<td style="text-align:right;">
Silver
</td>
<td style="text-align:right;">
Beige
</td>
<td style="text-align:right;">
2FMDK3KCXCBA73167
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:right;">
15999
</td>
<td style="text-align:right;">
2012
</td>
<td style="text-align:right;">
61834
</td>
<td style="text-align:right;">
Limited
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
Ventura, CA
</td>
<td style="text-align:right;">
White
</td>
<td style="text-align:right;">
Black
</td>
<td style="text-align:right;">
2FMDK3KC3CBA09052
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:right;">
13985
</td>
<td style="text-align:right;">
2012
</td>
<td style="text-align:right;">
84597
</td>
<td style="text-align:right;">
SEL
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
Ontario, CA
</td>
<td style="text-align:right;">
White Suede
</td>
<td style="text-align:right;">
Charcoal Black
</td>
<td style="text-align:right;">
2FMDK3J98CBA10168
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:right;">
12599
</td>
<td style="text-align:right;">
2012
</td>
<td style="text-align:right;">
87724
</td>
<td style="text-align:right;">
SEL
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
La Habra, CA
</td>
<td style="text-align:right;">
Silver
</td>
<td style="text-align:right;">
Beige
</td>
<td style="text-align:right;">
2FMDK3J9XCBA82165
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:right;">
13711
</td>
<td style="text-align:right;">
2012
</td>
<td style="text-align:right;">
94112
</td>
<td style="text-align:right;">
Limited
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
Alhambra, CA
</td>
<td style="text-align:right;">
White Platinum
</td>
<td style="text-align:right;">
Charcoal Black
</td>
<td style="text-align:right;">
2FMDK3KC2CBA41538
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:right;">
14987
</td>
<td style="text-align:right;">
2012
</td>
<td style="text-align:right;">
77240
</td>
<td style="text-align:right;">
Limited
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
Lancaster, CA
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
2FMDK3KCXCBA41688
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:right;">
15432
</td>
<td style="text-align:right;">
2012
</td>
<td style="text-align:right;">
61006
</td>
<td style="text-align:right;">
Limited
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
Corona, CA
</td>
<td style="text-align:right;">
Silver
</td>
<td style="text-align:right;">
Beige
</td>
<td style="text-align:right;">
2FMDK3KCXCBA73167
</td>
<td style="text-align:right;">
NA
</td>
</tr>
</tbody>
</table>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>Python’s <code>beautifulSoup</code> package could probably do a better job.<a href="#fnref1">↩</a></p></li>
<li id="fn2"><p>I tried scraping CarGurus, but wasn’t able to paginate. I tried scraping CarMax, but had difficulty. Edmunds was also easy, but Truecar was easiset.<a href="#fnref2">↩</a></p></li>
</ol>
</div>
