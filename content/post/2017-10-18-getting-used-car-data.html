---
title: Webscraping Thousands of Used Cars
author: ~
date: '2017-10-18'
slug: getting-used-car-data
categories: ['tutorials']
tags: ['r', 'webscraping']
---

<script src="/rmarkdown-libs/htmlwidgets/htmlwidgets.js"></script>
<script src="/rmarkdown-libs/jquery/jquery.min.js"></script>
<script src="/rmarkdown-libs/datatables-binding/datatables.js"></script>
<link href="/rmarkdown-libs/dt-core/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="/rmarkdown-libs/dt-core/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="/rmarkdown-libs/dt-core/js/jquery.dataTables.min.js"></script>


<p>In another post, I describe how I use this data that I’ve scraped, but I wanted to provide a more in-depth tutorial for those interested in how I got the data. Note, this data belongs to Truecar, so all uses herein are for personal and academic reasons only.</p>
<div id="get-the-data" class="section level1">
<h1>Get the data</h1>
<p>In order to do any good analaysis, you first need data. I prefer to have more data than less, where possible. In this case, I don’t have any data, so I use webscraping to get the data. There are much better tutorials on how to scrape data, so I’ll be light. I use R’s <code>rvest</code> package here, which does a decent job.<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a> Let’s look at Truecar’s Used Car postings<a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a>. First I use <code>google</code> to find the search query on Truecar that I like.</p>
<pre class="r"><code># Load packages
library(rvest)
library(dplyr)
library(magrittr)</code></pre>
<pre class="r"><code># Find the URL of the data you want to scrape
url &lt;- &#39;https://www.truecar.com/used-cars-for-sale/listings/ford/edge/location-90210/year-2015-max/?trimSlug=sel-awd&#39;
read_html(url)</code></pre>
<pre><code>## {xml_document}
## &lt;html lang=&quot;en-US&quot; data-qa=&quot;Index&quot;&gt;
## [1] &lt;head&gt;\n&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset= ...
## [2] &lt;body&gt;&lt;div&gt;\n&lt;div&gt;&lt;div id=&quot;main&quot;&gt;&lt;div&gt;&lt;div data-qa=&quot;TransitionHooks&quot; ...</code></pre>
<p>You’ll see there’s a head and a body. Our data’s in the body, so let’s use <code>html_nodes()</code> and <code>html_text()</code> to parse out the data we want. I used <a href="https://cran.r-project.org/web/packages/rvest/vignettes/selectorgadget.html">Selectorgadget</a> to know what HTML classes to search for.</p>
<pre class="r"><code>read_html(url) %&gt;% html_nodes(&#39;.col-xs-6.col-sm-8.no-left-padding&#39;) %&gt;% html_text()</code></pre>
<pre><code>##  [1] &quot;2015 Ford EdgeSEMileage: 45,702 milesLocation: Santa Ana, CAExterior: Ingot Silver MetallicInterior: BlackVIN: 2FMTK3G84FBB96919$14,899View Details&quot;                                                                  
##  [2] &quot;2015 Ford EdgeSEMileage: 31,750 milesLocation: Los Angeles, CAExterior: SilverInterior: BlackVIN: 2FMTK3G96FBB52901 Rating: Great Price$17,980$6,458 below marketView Details&quot;                                        
##  [3] &quot;2015 Ford EdgeSEMileage: 62,844 milesLocation: Pacoima, CAExterior: BlackVIN: 2FMTK4G87FBB97410$15,482View Details&quot;                                                                                                   
##  [4] &quot;2015 Ford EdgeSEMileage: 36,399 milesLocation: Huntington Beach, CAExterior: Tuxedo BlackInterior: EbonyVIN: 2FMTK3G97FBB92565$17,890View Details&quot;                                                                    
##  [5] &quot;2015 Ford EdgeSEMileage: 35,874 milesLocation: Huntington Beach, CAExterior: Tuxedo Black MetallicInterior: EbonyVIN: 2FMTK3G98FBC34774$18,990View Details&quot;                                                           
##  [6] &quot;2015 Ford EdgeSELMileage: 21,829 milesLocation: Los Angeles, CAExterior: GrayInterior: BlackVIN: 2FMTK3J95FBB01835 Rating: Great Price$20,480$7,063 below marketView Details&quot;                                         
##  [7] &quot;2015 Ford EdgeSEMileage: 62,747 milesLocation: Montclair, CAExterior: GrayInterior: TanVIN: 2FMTK3G98FBB43553Discount Available  Rating: Great Price$15,400$8,373 below marketView Details&quot;                           
##  [8] &quot;2015 Ford EdgeSEMileage: 7,526 milesLocation: Glendale, CAExterior: WhiteInterior: DuneVIN: 2FMTK3G95FBC20895$22,500View Details&quot;                                                                                     
##  [9] &quot;2015 Ford EdgeSEMileage: 22,098 milesLocation: Downey, CAExterior: WhiteInterior: BlackVIN: 2FMTK4G88FBC08043$20,400View Details&quot;                                                                                     
## [10] &quot;2015 Ford EdgeSEMileage: 30,332 milesLocation: Downey, CAExterior: WhiteInterior: BlackVIN: 2FMTK4G92FBB40573$19,900View Details&quot;                                                                                     
## [11] &quot;2015 Ford EdgeSELMileage: 33,841 milesLocation: Downey, CAExterior: BlackInterior: BlackVIN: 2FMTK3J86FBB20045 Rating: Great Price$21,500$4,454 below marketView Details&quot;                                             
## [12] &quot;2015 Ford EdgeSELMileage: 5,470 milesLocation: Glendora, CAExterior: Guard MetallicInterior: EbonyVIN: 2FMTK3J98FBC40065$23,965View Details&quot;                                                                          
## [13] &quot;2015 Ford EdgeTitaniumMileage: 30,703 milesLocation: Montebello, CAExterior: Tuxedo Black MetallicInterior: BlackVIN: 2FMPK3K8XFBB06293$22,499View Details&quot;                                                           
## [14] &quot;2015 Ford EdgeSELMileage: 41,010 milesLocation: GARDEN GROVE, CAExterior: GrayInterior: EbonyVIN: 2FMTK3J94FBB47723$22,495View Details&quot;                                                                               
## [15] &quot;2015 Ford EdgeSELMileage: 77,865 milesLocation: Rancho Santa Margarita, CAExterior: Tuxedo Black MetallicInterior: DuneVIN: 2FMTK3J94FBB47740$18,700View Details&quot;                                                     
## [16] &quot;2015 Ford EdgeSELMileage: 18,208 milesLocation: Carson, CAExterior: Ingot Silver MetallicInterior: EbonyVIN: 2FMTK4J82FBC05227Discount Available $24,997View Details&quot;                                                 
## [17] &quot;2015 Ford EdgeSELMileage: 30,942 milesLocation: Huntington Beach, CAExterior: Ingot SilverInterior: EbonyVIN: 2FMTK3J98FBB45599$23,490View Details&quot;                                                                   
## [18] &quot;2015 Ford EdgeSELMileage: 38,035 milesLocation: Downey, CAExterior: WhiteInterior: BeigeVIN: 2FMTK4J93FBB59643$22,100View Details&quot;                                                                                    
## [19] &quot;2015 Ford EdgeSELMileage: 38,633 milesLocation: Downey, CAExterior: BlackInterior: BlackVIN: 2FMTK4J9XFBC10183$22,200View Details&quot;                                                                                    
## [20] &quot;2015 Ford EdgeSELMileage: 27,169 milesLocation: Alhambra, CAExterior: BlackInterior: EbonyVIN: 2FMTK3J94FBB45521$24,991View Details&quot;                                                                                  
## [21] &quot;2015 Ford EdgeSELMileage: 24,922 milesLocation: Long Beach, CAExterior: BlackInterior: EbonyVIN: 2FMTK3J8XFBB55896Discount Available $24,378View Details&quot;                                                             
## [22] &quot;2015 Ford EdgeTitaniumMileage: 19,284 milesLocation: Huntington Beach, CAExterior: Tuxedo Black MetallicInterior: EbonyVIN: 2FMPK3K87FBB67701$25,590View Details&quot;                                                     
## [23] &quot;2015 Ford EdgeTitaniumMileage: 36,482 milesLocation: Downey, CAExterior: SilverInterior: BlackVIN: 2FMTK3K9XFBB06656 Rating: Great Price$23,400$6,371 below marketView Details&quot;                                       
## [24] &quot;2015 Ford EdgeSELMileage: 29,704 milesLocation: Huntington Beach, CAExterior: Tuxedo BlackInterior: EbonyVIN: 2FMTK3J99FBB47748$24,890View Details&quot;                                                                   
## [25] &quot;2015 Ford EdgeSELMileage: 19,405 milesLocation: Long Beach, CAExterior: BlackInterior: EbonyVIN: 2FMTK3J80FBB34135Discount Available $25,133View Details&quot;                                                             
## [26] &quot;2015 Ford EdgeSELMileage: 66 milesLocation: Los Angeles, CAExterior: Ruby Red MetallicInterior: EbonyVIN: 2FMTK4J80FBC39960Discount Available $27,995View Details&quot;                                                    
## [27] &quot;2015 Ford EdgeTitaniumMileage: 33,017 milesLocation: Downey, CAExterior: RedInterior: BlackVIN: 2FMTK3K91FBB43725$23,900View Details&quot;                                                                                 
## [28] &quot;2015 Ford EdgeSELMileage: 31,286 milesLocation: Los Angeles, CAExterior: RedInterior: EbonyVIN: 2FMPK4J98FBC39957Discount Available $25,498View Details&quot;                                                              
## [29] &quot;2015 Ford EdgeSELMileage: 46,451 milesLocation: Cerritos, CAExterior: WhiteInterior: TanVIN: 2FMTK4J90FBB34408$23,448View Details&quot;                                                                                    
## [30] &quot;2015 Ford EdgeTitaniumMileage: 25,899 milesLocation: Woodland Hills, CAExterior: GrayVIN: 2FMTK3K92FBB21314Discount Available $27,000View Details&quot;                                                                    
## [31] &quot;2015 Ford EdgeSELMileage: 16,995 milesLocation: Long Beach, CAExterior: BlackInterior: EbonyVIN: 2FMTK3J80FBB34071Discount Available $25,721View Details&quot;                                                             
## [32] &quot;2015 Ford EdgeSELMileage: 36,406 milesLocation: Long Beach, CAExterior: BlackInterior: EbonyVIN: 2FMTK4J80FBB48669Discount Available  Rating: Great Price$24,389$4,717 below marketView Details&quot;                      
## [33] &quot;2015 Ford EdgeSELMileage: 30,080 milesLocation: Huntington Beach, CAExterior: Ingot SilverInterior: EbonyVIN: 2FMTK3J84FBB45512 Rating: Great Price$25,890$2,066 below marketView Details&quot;                            
## [34] &quot;2015 Ford EdgeSELMileage: 56,147 milesLocation: Fontana, CAExterior: BlackInterior: EbonyVIN: 2FMPK3J89FBB27881$20,995View Details&quot;                                                                                   
## [35] &quot;2015 Ford EdgeTitaniumMileage: 42,797 milesLocation: Downey, CAExterior: Dk. GrayInterior: BlackVIN: 2FMTK3K91FBB22535$24,200View Details&quot;                                                                            
## [36] &quot;2015 Ford EdgeTitaniumMileage: 37,313 milesLocation: Downey, CAExterior: Off WhiteInterior: BlackVIN: 2FMTK3K82FBB56197$25,200View Details&quot;                                                                           
## [37] &quot;2015 Ford EdgeTitaniumMileage: 44,860 milesLocation: San Juan Capistrano, CAExterior: White Platinum Metallic Tri-CoatInterior: EbonyVIN: 2FMTK3K92FBB43801 Rating: Great Price$22,895$7,327 below marketView Details&quot;
## [38] &quot;2015 Ford EdgeSELMileage: 40,057 milesLocation: Upland, CAExterior: BlackInterior: BlackVIN: 2FMTK3J85FBB34115$24,880View Details&quot;                                                                                    
## [39] &quot;2015 Ford EdgeTitaniumMileage: 24,267 milesLocation: Downey, CAExterior: BlackInterior: BlackVIN: 2FMTK3K86FBB66389$26,600View Details&quot;                                                                               
## [40] &quot;2015 Ford EdgeSportMileage: 15,515 milesLocation: Long Beach, CAExterior: Tuxedo Black MetallicInterior: EbonyVIN: 2FMTK3AP8FBB73837Discount Available $28,967View Details&quot;                                           
## [41] &quot;2015 Ford EdgeSELMileage: 35,269 milesLocation: Chino, CAExterior: Ingot Silver MetallicInterior: EbonyVIN: 2FMTK3J98FBB67750$25,775View Details&quot;                                                                     
## [42] &quot;2015 Ford EdgeSportMileage: 53,110 milesLocation: Garden Grove, CAExterior: ChromeInterior: AluminumVIN: 2FMTK3AP9FBB09242Discount Available $23,995View Details&quot;                                                     
## [43] &quot;2015 Ford EdgeTitaniumMileage: 47,589 milesLocation: Downey, CAExterior: RedInterior: BeigeVIN: 2FMTK4K91FBB56691 Rating: Great Price$25,100$6,937 below marketView Details&quot;                                          
## [44] &quot;2015 Ford EdgeTitaniumMileage: 48,183 milesLocation: Long Beach, CAExterior: Tuxedo Black MetallicInterior: EbonyVIN: 2FMTK4K90FBB61994Discount Available  Rating: Great Price$25,354$6,439 below marketView Details&quot; 
## [45] &quot;2015 Ford EdgeSELMileage: 43,937 milesLocation: Riverside, CAExterior: Ruby Red Metallic Tinted ClearcoatInterior: DuneVIN: 2FMTK3J82FBB55861$24,985View Details&quot;</code></pre>
<p>So that’s how you get the data on a single page. If you look closer at the URL, you see a lot of helpful things. First, there’s the make, then the model, then the location-zip, then the year-range, and ultimately the trim. This is a very pretty and clean URL. If you click on a few additional pages, you’ll see the URL opens up with <code>?page=2</code>.</p>
<pre><code>https://www.truecar.com/used-cars-for-sale/listings/ford/edge/location-90210/?page=2</code></pre>
<p>This is our ‘in’ to scraping multiple pages. I won’t bore you with the details of how to get <em>that</em> data into a neat matrix for us to analyze, but suffice it to say that I’m able to do it. Just build a function to construct a URL, and build a loop to go through the different pages, then use lots of <code>str_extract</code> from the <code>stringr</code> package and <code>gsub</code> to clean up the data.</p>
<pre class="r"><code>library(stringr)

make = &#39;ford&#39;
model = &#39;edge&#39;
zip = &#39;90210&#39;
year = 2012
npages = 5

url &lt;- paste(&#39;https://www.truecar.com/used-cars-for-sale/listings/&#39;, 
             make, &#39;/&#39;, 
             model ,
             &#39;/location-&#39;, zip,
             &#39;/year-&#39;,year,&#39;-max/?page=&#39;, sep = &quot;&quot;)

urls &lt;- paste(url, 1:npages, sep = &quot;&quot;)

scrape &lt;- function(pageno){
  try(
    read_html(urls[pageno]) %&gt;% html_nodes(&#39;.col-xs-6.col-sm-8.no-left-padding&#39;) %&gt;% html_text()
  )
}

long_list = scrape(1)
for(i in 2:npages){
  print(i)
  new_list = try(scrape(i))
  
  error = (&quot;try-error&quot; %in% class(new_list))
  
  if( error == FALSE ){
    long_list = c(long_list, new_list) 
  } else {
    break
  }
}</code></pre>
<pre><code>## [1] 2
## [1] 3
## [1] 4
## [1] 5</code></pre>
<pre class="r"><code>stats &lt;- long_list
df &lt;- as.data.frame(stats)
df$stats %&lt;&gt;% as.character()
df$price &lt;- str_extract(df$stats, &#39;\\$[0-9]*,[0-9]*&#39;) %&gt;% 
  gsub(&#39;Price: |\\$|,&#39;, &#39;&#39;, .) %&gt;%
  as.numeric()
df$year &lt;- str_extract(df$stats, &#39;^[0-9]* &#39;) %&gt;% 
  as.numeric()
df$mileage &lt;- str_extract(df$stats, &#39;Mileage: [0-9]*,[0-9]*&#39;) %&gt;% 
  gsub(&#39;Mileage: |,&#39;, &#39;&#39;, .) %&gt;%
  as.numeric()

# a = df$stats[1]
df$trim &lt;- str_extract(df$stats, &#39;.*Mileage:&#39;) %&gt;% 
  gsub(&#39;FWD|AWD|4x[24]|[24]WD|V6|4-cyl|^[0-9][0-9][0-9][0-9]|4dr|Automatic|Manual|Mileage:&#39;, &#39;&#39;, ., ignore.case = T) %&gt;% 
  gsub(make, &#39;&#39;, ., ignore.case = T) %&gt;% 
  gsub(model, &#39;&#39;, ., ignore.case = T) %&gt;% 
  trimws() 


df$awd &lt;- grepl(&#39;AWD|4WD|4x4&#39;, df$stats, ignore.case = T) %&gt;% as.numeric()
df$manual &lt;- grepl(&#39;manual&#39;, df$stats) %&gt;% as.numeric()
df$v6 &lt;- grepl(&#39;V6&#39;, df$stats) %&gt;% as.numeric()
df$location &lt;- str_extract(df$stats, &#39;Location: .*Exterior:&#39;) %&gt;% 
  gsub(&#39;Location: |Exterior:&#39;, &#39;&#39;, .) %&gt;% 
  trimws() 
df$ext &lt;- str_extract(df$stats, &#39;Exterior: .*Interior:&#39;) %&gt;% 
  gsub(&#39;Interior:|Exterior:&#39;, &#39;&#39;, .) %&gt;% 
  trimws() 
df$int &lt;- str_extract(df$stats, &#39;Interior: .*VIN:&#39;) %&gt;% 
  gsub(&#39;Interior: |VIN:&#39;, &#39;&#39;, .) %&gt;% 
  trimws() 
df$vin &lt;- str_extract(df$stats, &#39;VIN: .*\\$&#39;) %&gt;% 
  gsub(&#39;VIN: |\\$&#39;, &#39;&#39;, .) %&gt;% 
  substr(., 1, 17)
df$deal &lt;- str_extract(df$stats, &#39;\\$[0-9]*,[0-9]* below&#39;) %&gt;% 
  gsub(&#39;below|\\$|,&#39;, &#39;&#39;, .) %&gt;% trimws() %&gt;%
  as.numeric()</code></pre>
<p>And here’s what the results look like. You’ve got the original scraped data in the <code>stats</code> column and then everything else that you can parse out. Just like that, you’ve got</p>
<pre class="r"><code># df was the dataframe object we needed
head(df) %&gt;% DT::datatable()</code></pre>
<div id="htmlwidget-1" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-1">{"x":{"filter":"none","data":[["1","2","3","4","5","6"],["2012 Ford EdgeSELMileage: 87,179 milesLocation: Long Beach, CAExterior: Ingot Silver MetallicInterior: Charcoal BlackVIN: 2FMDK3JCXCBA82243Discount Available $12,967View Details","2012 Ford EdgeLimitedMileage: 83,415 milesLocation: Thousand Oaks, CAExterior: WhiteInterior: TanVIN: 2FMDK3KC6CBA95361Discount Available $13,333View Details","2012 Ford EdgeSELMileage: 41,470 milesLocation: Woodland Hills, CAExterior: CinnamonVIN: 2FMDK3J94CBA49744$18,000View Details","2012 Ford EdgeLimitedMileage: 77,883 milesLocation: Mission Hills, CAExterior: SilverVIN: 2FMDK3KC2CBA41460Discount Available $14,992View Details","2012 Ford EdgeLimitedMileage: 83,603 milesLocation: Irvine, CAExterior: Ingot Silver MetallicInterior: Charcoal BlackVIN: 2FMDK3K96CBA46150$13,980View Details","2012 Ford EdgeSportMileage: 58,297 milesLocation: Buena Park, CAExterior: Tuxedo Black MetallicInterior: Charcoal BlackVIN: 2FMDK3AK7CBA93272$17,980View Details"],[12967,13333,18000,14992,13980,17980],[2012,2012,2012,2012,2012,2012],[87179,83415,41470,77883,83603,58297],["SEL","Limited","SEL","Limited","Limited","Sport"],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],["Long Beach, CA","Thousand Oaks, CA","Woodland Hills, CA","Mission Hills, CA","Irvine, CA","Buena Park, CA"],["Ingot Silver Metallic","White",null,null,"Ingot Silver Metallic","Tuxedo Black Metallic"],["Charcoal Black","Tan",null,null,"Charcoal Black","Charcoal Black"],["2FMDK3JCXCBA82243","2FMDK3KC6CBA95361","2FMDK3J94CBA49744","2FMDK3KC2CBA41460","2FMDK3K96CBA46150","2FMDK3AK7CBA93272"],[null,null,null,null,null,null]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>stats<\/th>\n      <th>price<\/th>\n      <th>year<\/th>\n      <th>mileage<\/th>\n      <th>trim<\/th>\n      <th>awd<\/th>\n      <th>manual<\/th>\n      <th>v6<\/th>\n      <th>location<\/th>\n      <th>ext<\/th>\n      <th>int<\/th>\n      <th>vin<\/th>\n      <th>deal<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3,4,6,7,8,13]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>Python’s <code>beautifulSoup</code> package could probably do a better job.<a href="#fnref1">↩</a></p></li>
<li id="fn2"><p>I tried scraping CarGurus, but wasn’t able to paginate. I tried scraping CarMax, but had difficulty. Edmunds was also easy, but Truecar was easiset.<a href="#fnref2">↩</a></p></li>
</ol>
</div>
